<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="../../_static/favicon_16x16.png" sizes="16x11" rel="icon" type="image/png">
    <link href="../../_static/favicon_32x32.png" sizes="32x21" rel="icon" type="image/png">
    <title>Architecture Design Record - Event Storage Backend &#8212; elos  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=4f649999" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=039e1c02" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Handle kernel module dependencies for Elos" href="handle_kernel_module_dependencies.html" />
    <link rel="prev" title="Architecture Design Record - Blacklist filtering of published events" href="event_authorization_blacklisting.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="architecture-design-record-event-storage-backend">
<h1>Architecture Design Record - Event Storage Backend<a class="headerlink" href="#architecture-design-record-event-storage-backend" title="Permalink to this heading">¶</a></h1>
<section id="problem">
<h2>Problem<a class="headerlink" href="#problem" title="Permalink to this heading">¶</a></h2>
<p>An event storage backend for elos has the task to persist and retrieve
events utilizing techniques to fulfill a set of characteristics required
to store and retrieve one or more classes of events (<a class="reference external" href="event_storage_class.md">event storage
classes</a>).</p>
</section>
<section id="influencing-factors">
<h2>Influencing factors<a class="headerlink" href="#influencing-factors" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>retention policy</p></li>
<li><p>assurance about write integrity</p></li>
<li><p>assurance about data integrity</p></li>
<li><p>write speed</p></li>
<li><p>read speed</p></li>
<li><p>flash usage per event persistence operation</p></li>
<li><p>space requirements per event (compression)</p></li>
</ul>
<p>The task is now to define possible event storage backend implementation
and define there characteristics. These could then be used to choose an
implementation which fits best to store a given class of events.</p>
</section>
<section id="assumptions">
<h2>Assumptions<a class="headerlink" href="#assumptions" title="Permalink to this heading">¶</a></h2>
</section>
<section id="considered-alternatives">
<h2>Considered Alternatives<a class="headerlink" href="#considered-alternatives" title="Permalink to this heading">¶</a></h2>
<section id="rdbms-sqlite">
<span id="id1"></span><h3>1) RDBMS - SQLite<a class="headerlink" href="#rdbms-sqlite" title="Permalink to this heading">¶</a></h3>
<p>SQLite is not a conventional RDBMS as it comes as a library and not as
classical client-/server based approach. SQLite targets embedded systems
and intended to provide an commonly used and known SQL-Interface to
manage data.</p>
<p><em>TBD: evaluation, measurements, PoC</em></p>
<p><em>pros</em></p>
<ul class="simple">
<li><p>optimized for embedded system by design</p></li>
<li><p>extension API to add custom driver to store data</p></li>
</ul>
<p><em>cons</em></p>
<ul class="simple">
<li><p>probably less effective on big complex data sets as common full
featured RDBMSs</p>
<ul>
<li><p>But: Is it intentional to manage data quantities and complex data
structures that a classical RDBMS representative should be
considered</p></li>
</ul>
</li>
</ul>
</section>
<section id="nosql-mongodb">
<span id="id2"></span><h3>2) NoSQL – MongoDB<a class="headerlink" href="#nosql-mongodb" title="Permalink to this heading">¶</a></h3>
<p>MongoDB is a representative of the document orientated NoSQL-Databases.
Each event can be considered as a document in in the NoSql context.
NoSql databases are designed to search for through and for particular
attributes of documents.</p>
<p><em>TBD: evaluation, measurements, PoC</em></p>
<p><em>pros</em></p>
<ul class="simple">
<li><p>simplicity, straight forward take the event and store it without
further processing</p></li>
</ul>
<p><em>cons</em></p>
<ul class="simple">
<li><p>needs a mongoDB server which comes with additional dependencies like
python</p></li>
</ul>
</section>
<section id="custom-file-storage-json-file">
<span id="id3"></span><h3>2) Custom File Storage – Json File<a class="headerlink" href="#custom-file-storage-json-file" title="Permalink to this heading">¶</a></h3>
<p>To address the special requirements on storing events a sequential
approach to store events serialized as newline Json separated strings is
possible.</p>
<p>To reduce the writes techniques like preallocating a file on the backing
filesystem and storage is used. To address the atomic write dependency
specific flags for writing like O_SYNC and O_DSYNC can be used. More
details on this approach can be obtained from the corresponding design
decision.</p>
<p><em>TBD: evaluation, measurements, PoC</em></p>
<p><em>pros</em></p>
<ul class="simple">
<li><p>simplicity, straight forward take the event and store it without
further processing</p></li>
<li><p>an implementation from scratch can be highly customized to the
specific needs and abilities of the used target system</p></li>
</ul>
<p><em>cons</em></p>
<ul class="simple">
<li><p>probably high development effort</p></li>
<li><p>danger of reinventing some other stream or file storage system over
time, as more and more “lessons learned”</p></li>
</ul>
</section>
<section id="systemd-like-storage-of-logs">
<span id="id4"></span><h3>3) systemd like storage of logs<a class="headerlink" href="#systemd-like-storage-of-logs" title="Permalink to this heading">¶</a></h3>
<p><a class="reference external" href="https://systemd.io/JOURNAL_FILE_FORMAT/">https://systemd.io/JOURNAL_FILE_FORMAT/</a>
<a class="reference external" href="https://github.com/systemd/systemd">https://github.com/systemd/systemd</a>
<a class="reference external" href="https://www.freedesktop.org/software/systemd/man/sd-journal.html">https://www.freedesktop.org/software/systemd/man/sd-journal.html</a></p>
<p>systemds journald subsystem is a logging system not too different from
syslog. It is, effectively, a block-based protocol, writing its logs to
a socket.</p>
</section>
</section>
<section id="decision">
<h2>Decision<a class="headerlink" href="#decision" title="Permalink to this heading">¶</a></h2>
<p>Systemds journald will not be used. If the decision is reached to
implement a completly new logging mechanism, the data storage format
from journald is a good reference on how to write a logging format that
is easily searchable.</p>
<section id="rationale">
<h3>Rationale<a class="headerlink" href="#rationale" title="Permalink to this heading">¶</a></h3>
<p>The API of journald does not support writing to a custom file/location,
which means that we can not simply use the API for logging. It is
possible to change the location of the logging directory by setting an
enviroment variable and giving it to the journald server. However, Using
the journald server requires to start all of systemd. From
investigations it seems no functions related to the journald server are
available for other programs via a shared library. Additionally, due to
systemds design, it seems unlikely that a separate journald sever would
run without the rest of systemd available on the machine.</p>
<p>Furthermore, it is unsure if using the journald protocol would satisfy
our requirements for a logging protocol. According to the official
documentation, it is to be assumed, that we need to write at least 3
block when creating an entry. One block for the header that needs
updating, one block to update the entry array element which will contain
the new entry, and one for the entry. When the current entry array is
full, we might only need to write two blocks, since the entry array
struct and the entry itself should fit into a single block.
Additionally, sometimers a tag struct will be written for corruption
protection, but this can fit into the same block as the entry as well. S
the best case scenario is two block for a single entry write, and worst
case is 4. While an new log entry is not necessarily written to the disc
instantly, current code research indicates that every write does
schedule a sync with the disc. This means that multiple log entries can
pile up before the sync actually occures. This would reduce unnecessary
the amount of times the file and list headers need to be updated. If the
amount of log entries pilung up is sufficiently large, the overhead from
those header writes would become relativly small.</p>
<p>The focus of the protocol is corruption optimisation, to ensure that as
little data is corrupted and as much of the data is still useable after
a corruption is detected. To achieve this, every read checks for data
consistency while reading, as well as writing tags after an amount of
entries. The first protection mechansims is highly dependent on the
amount of actual reads that happen. The other focus of the protocol is
to make it easily searchable, with having an search efficiency of O(n)
in the worst case for n total entries, even when searching by multiple
parameters.</p>
<p>The compatibility between the protocols data storage and our even
storage is rather good. The format stores the date, as well as a
“priority” data field, which we can sue to store our data and severity
data. Additionally, the protocol does not have strong requirements for
the name of its data fields, meaning we can store the rest of our event
data fields in plain text, with an appropriate encoding of our field
names. Combining that with the efficient search with field names as
search parameters would make lookup pretty efficient.</p>
</section>
<section id="open-points">
<h3>Open Points<a class="headerlink" href="#open-points" title="Permalink to this heading">¶</a></h3>
<p>It is unclear if, should we be able to create a shared library for the
journald server, how much of systemds other sources we would need to
install as well to enable the server to run. It was not possible for our
engineers to create a shared library from those. This does not
necessarily mean that a more skilled engineer could not make that
possible. It is unclear how long the time between a sync scheduling and
the actual disc sync is and how many logs would accumulate in that time.
It is unclear how good the corruption protection would work for elos,
depending on how many lookups actually happen.</p>
</section>
<section id="apache-avro-storage-of-logs">
<span id="id5"></span><h3>4) Apache Avro Storage of logs<a class="headerlink" href="#apache-avro-storage-of-logs" title="Permalink to this heading">¶</a></h3>
<p><a class="reference external" href="https://avro.apache.org/docs/1.11.1/api/c/">https://avro.apache.org/docs/1.11.1/api/c/</a></p>
<p>Avro supports storing of binary data in an easy way.</p>
</section>
</section>
</section>
<section id="decision-1">
<span id="id6"></span><h1>Decision<a class="headerlink" href="#decision-1" title="Permalink to this heading">¶</a></h1>
<p>Creating a code poc is necessary to determine how the api performs in
regards to writing blocks. During the creation of the poc, further
development was halted and avro was abandoned as a possible logging
backend.</p>
<section id="rationale-1">
<span id="id7"></span><h2>Rationale<a class="headerlink" href="#rationale-1" title="Permalink to this heading">¶</a></h2>
<p>It is certain that we can store an event fully in the data structures
available from Avro.</p>
<p>During the development of the poc, an issue with the locally available
avro dev library was found, in which the software contained a bug,
making the library unable to open a file it previously created. This
made it impossible to reopen a file that was previously written to,
which makes closing the file during operation impossible and would
require a new log file after each start of the application.
Additionally, and more importantly, it is impossible to open old log
files for reading.</p>
<p>Trying to build avro locally in order to patch it by ourself proved
difficult as as well, due to the amount of dependencies. Some
dependencies are not available in the necessary version locally, which
would require building them as well.</p>
<p>When trying to build avro locally, while supplying the necessary
dependencies, The build failed to varying reasons, even with the same
setup.</p>
</section>
<section id="open-points-1">
<span id="id8"></span><h2>Open Points<a class="headerlink" href="#open-points-1" title="Permalink to this heading">¶</a></h2>
<p>The amount of actual writes that happen when storing an event is
unclear, but at least from the poc development, it seems reasonable to
assume that it is possible to cache multiple events before actually
writing them to file.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/elos_blue.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">elos</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../UserManual.html">Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../demo.html">Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">elos API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">Developers</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="adrs.html">Architecture Design Records</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="atomic_variables.html">Architecture Design Record - Atomic Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_logging_storage_concept.html">Architecture Design Record - Event Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_retention_policies.html">Architecture Design Record - Event Retention Policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_storage_class.html">Architecture Design Record - Event Storage Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_throtteling.html">Architecture Design Record - Event Throtteling</a></li>
<li class="toctree-l2"><a class="reference internal" href="usage_of_FORTIFY_SOURCE.html">Design Decisions - Enforce usage of _FORTIFY_SOURCE</a></li>
<li class="toctree-l2"><a class="reference internal" href="elos-coredump.html">Architecture Design Record - Detecting Coredumps</a></li>
<li class="toctree-l2"><a class="reference internal" href="elos_logging_frameworks.html">Architecture Design Record - Evaluation Of Logging Frameworks</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_authorization.html">Architecture Design Record - Event publishing authorization</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_authorization_blacklisting.html">Architecture Design Record - Blacklist filtering of published events</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Architecture Design Record - Event Storage Backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="#decision-1">Decision</a></li>
<li class="toctree-l2"><a class="reference internal" href="handle_kernel_module_dependencies.html">Handle kernel module dependencies for Elos</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_registry.html">Evaluation of the gitlab package registry, with regards to storing and using the elos subproject debian packages.</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="adrs.html">Architecture Design Records</a><ul>
      <li>Previous: <a href="event_authorization_blacklisting.html" title="previous chapter">Architecture Design Record - Blacklist filtering of published events</a></li>
      <li>Next: <a href="handle_kernel_module_dependencies.html" title="next chapter">Handle kernel module dependencies for Elos</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, wolfgang.gehrhardt@emlix.com.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/generated/ADRs/event_storage_backends.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>