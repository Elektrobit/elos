<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="../../_static/favicon_16x16.png" sizes="16x11" rel="icon" type="image/png">
    <link href="../../_static/favicon_32x32.png" sizes="32x21" rel="icon" type="image/png">
    <title>Design Decisions - Enforce usage of _FORTIFY_SOURCE &#8212; elos  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=4f649999" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=039e1c02" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Evaluation of the gitlab package registry, with regards to storing and using the elos subproject debian packages." href="package_registry.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="design-decisions-enforce-usage-of-fortify-source">
<h1>Design Decisions - Enforce usage of _FORTIFY_SOURCE<a class="headerlink" href="#design-decisions-enforce-usage-of-fortify-source" title="Link to this heading">¶</a></h1>
<section id="problem">
<h2>Problem<a class="headerlink" href="#problem" title="Link to this heading">¶</a></h2>
<div class="line-block">
<div class="line">The libc defines in features.h the compiler define _FORTIFY_SOURCE
witch can have different levels 0 to 2.</div>
<div class="line">Taken from /usr/include/features.h</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_FORTIFY_SOURCE</span>      <span class="n">Add</span> <span class="n">security</span> <span class="n">hardening</span> <span class="n">to</span> <span class="n">many</span> <span class="n">library</span> <span class="n">functions</span><span class="o">.</span>
                     <span class="n">Set</span> <span class="n">to</span> <span class="mi">1</span> <span class="ow">or</span> <span class="mi">2</span><span class="p">;</span> <span class="mi">2</span> <span class="n">performs</span> <span class="n">stricter</span> <span class="n">checks</span> <span class="n">than</span> <span class="mf">1.</span>
</pre></div>
</div>
<p>This leads the library header to make several optimizations and
replacements of functions to add additional compile time and runtime
checks. In case of the <em>recv</em> function this looks like:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">__fortify_function</span><span class="w"> </span><span class="kt">ssize_t</span>
<span class="n">recv</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">__fd</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">__buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">__n</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">sz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__glibc_objsize0</span><span class="w"> </span><span class="p">(</span><span class="n">__buf</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__glibc_safe_or_unknown_len</span><span class="w"> </span><span class="p">(</span><span class="n">__n</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="p">),</span><span class="w"> </span><span class="n">sz</span><span class="p">))</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">__recv_alias</span><span class="w"> </span><span class="p">(</span><span class="n">__fd</span><span class="p">,</span><span class="w"> </span><span class="n">__buf</span><span class="p">,</span><span class="w"> </span><span class="n">__n</span><span class="p">,</span><span class="w"> </span><span class="n">__flags</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__glibc_unsafe_len</span><span class="w"> </span><span class="p">(</span><span class="n">__n</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="p">),</span><span class="w"> </span><span class="n">sz</span><span class="p">))</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">__recv_chk_warn</span><span class="w"> </span><span class="p">(</span><span class="n">__fd</span><span class="p">,</span><span class="w"> </span><span class="n">__buf</span><span class="p">,</span><span class="w"> </span><span class="n">__n</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="p">,</span><span class="w"> </span><span class="n">__flags</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">__recv_chk</span><span class="w"> </span><span class="p">(</span><span class="n">__fd</span><span class="p">,</span><span class="w"> </span><span class="n">__buf</span><span class="p">,</span><span class="w"> </span><span class="n">__n</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="p">,</span><span class="w"> </span><span class="n">__flags</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Currently it is not defined whether we expected to use this additional
safety checks or not. This leads us to the problem that we need to
decide in the Unit Tests which function call is expected i.e. <em>recv</em> or
__recv_chck or one of the other alternatives.</p>
<p>see also:
<a class="reference external" href="https://www.redhat.com/en/blog/enhance-application-security-fortifysource">https://www.redhat.com/en/blog/enhance-application-security-fortifysource</a>
<a class="reference external" href="https://wiki.debian.org/Hardening#DEB_BUILD_HARDENING_FORTIFY_.28gcc.2Fg.2B-.2B-_-D_FORTIFY_SOURCE.3D2.29">https://wiki.debian.org/Hardening#DEB_BUILD_HARDENING_FORTIFY_.28gcc.2Fg.2B-.2B-_-D_FORTIFY_SOURCE.3D2.29</a></p>
</section>
<section id="influencing-factors">
<h2>Influencing factors<a class="headerlink" href="#influencing-factors" title="Link to this heading">¶</a></h2>
<p>The following constraints have to be taken into account for a suitable
solution:</p>
<ul class="simple">
<li><p>Performance of code using _FORTIFY_SOURCE</p></li>
</ul>
<section id="mocking-in-unit-tests">
<h3>Mocking in Unit-Tests<a class="headerlink" href="#mocking-in-unit-tests" title="Link to this heading">¶</a></h3>
<p>The FORTIFY_SOURCE mechanics are based mostly on macros and redirections
(wrapper) to some other implementation of functions. For unit testing we
have to know this and explicitly write test that expect and check for
other method calls as defined in the code under test. see example above.</p>
<p>In addition if we agree on using FORTIFY_SOURCE in any level, this
becomes a dependency for our projects. Otherwise the unit tests will
fail as they have to be adopted to expect special or other function
calls then the code under test suggests.</p>
</section>
<section id="libc-dependencies">
<h3>libC Dependencies<a class="headerlink" href="#libc-dependencies" title="Link to this heading">¶</a></h3>
<p>As a final consequence, projects are only usable on platforms with a
libc-implementation which has FORTIFY_SOURCE enabled on given level and
is compliant to the one used during development.</p>
</section>
</section>
<section id="assumptions">
<h2>Assumptions<a class="headerlink" href="#assumptions" title="Link to this heading">¶</a></h2>
<p>The following assumptions have been made in the decision process:</p>
<ul class="simple">
<li><p>_FORTIFY_SOURCE is configured during all builds, including the
Release build. Hence also on the target the code is using
_FORTIFY_SOURCE.</p></li>
</ul>
<p>libC (e.g. glibc) shall support _FORTIFY_SOURCE</p>
</section>
<section id="considered-alternatives">
<h2>Considered Alternatives<a class="headerlink" href="#considered-alternatives" title="Link to this heading">¶</a></h2>
<section id="enforce-fortify-source-1">
<span id="id1"></span><h3>1) Enforce _FORTIFY_SOURCE == 1<a class="headerlink" href="#enforce-fortify-source-1" title="Link to this heading">¶</a></h3>
<p>If _FORTIFY_SOURCE is set to 1, with compiler optimization level 1 (gcc
-O1) and above, checks that shouldn’t change the behavior of conforming
programs are performed.</p>
<p><strong>pros</strong></p>
<ul class="simple">
<li><p>basically recommended to use</p>
<ul>
<li><p>But: _FORTIFY_SOURCE == 2 is even more recommended</p></li>
</ul>
</li>
</ul>
<p><strong>cons</strong></p>
<ul class="simple">
<li><p>(none)</p></li>
</ul>
</section>
<section id="enforce-fortify-source-2">
<span id="id2"></span><h3>2) Enforce _FORTIFY_SOURCE == 2<a class="headerlink" href="#enforce-fortify-source-2" title="Link to this heading">¶</a></h3>
<p>With _FORTIFY_SOURCE set to 2 some more checking is added, but some
conforming programs might fail. Some of the checks can be performed at
compile time, and result in compiler warnings; other checks take place
at run time, and result in a run-time error if the check fails.</p>
<p><strong>pros</strong></p>
<ul class="simple">
<li><p>More recommended than _FORTIFY_SOURCE == 1</p></li>
<li><p>standard way in the community</p></li>
<li><p>provides most secure results</p></li>
</ul>
<p><strong>cons</strong></p>
<ul class="simple">
<li><p>Might cause issues (some conforming programs might fail.)</p>
<ul>
<li><p>But: The tests should detect these fails.</p></li>
</ul>
</li>
</ul>
</section>
<section id="enforce-fortify-source-0-disable">
<span id="id3"></span><h3>3) Enforce _FORTIFY_SOURCE == 0 (Disable)<a class="headerlink" href="#enforce-fortify-source-0-disable" title="Link to this heading">¶</a></h3>
<p>description of this alternative.</p>
<p><strong>pros</strong></p>
<ul class="simple">
<li><p>(none)</p></li>
</ul>
<p><strong>cons</strong></p>
<ul class="simple">
<li><p>buffer over flows might be left undetected.</p></li>
</ul>
</section>
</section>
<section id="decision">
<h2>Decision<a class="headerlink" href="#decision" title="Link to this heading">¶</a></h2>
<p>Option 2 is chosen.</p>
<section id="rationale">
<h3>Rationale<a class="headerlink" href="#rationale" title="Link to this heading">¶</a></h3>
</section>
<section id="open-points">
<h3>Open Points<a class="headerlink" href="#open-points" title="Link to this heading">¶</a></h3>
<p>none</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/elos_blue.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">elos</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../UserManual.html">Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../demo.html">Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">elos API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">Developers</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="adrs.html">Architecture Design Records</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="atomic_variables.html">Architecture Design Record - Atomic Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="elos-coredump.html">Architecture Design Record - Detecting Coredumps</a></li>
<li class="toctree-l2"><a class="reference internal" href="elos_event_logging_concept.html">Architecture Design Record - elos event logging concept <strong>DRAFT</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="elos_logging_frameworks.html">Architecture Design Record - Evaluation Of Logging Frameworks</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_authorization.html">Architecture Design Record - Event publishing authorization</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_authorization_blacklisting.html">Architecture Design Record - Blacklist filtering of published events</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_logging_storage_concept.html">Architecture Design Record - Event Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_retention_policies.html">Architecture Design Record - Event Retention Policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_storage_backends.html">Architecture Design Record - Event Storage Backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_storage_backends.html#decision-1">Decision</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_storage_backends.html#decision-2">Decision</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_storage_backends.html#rational">Rational</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_storage_class.html">Architecture Design Record - Event Storage Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_throtteling.html">Architecture Design Record - Event Throtteling</a></li>
<li class="toctree-l2"><a class="reference internal" href="fetch-features.html">ADR - Feature set of elos “fetch” <strong>DRAFT</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="handle_kernel_module_dependencies.html">Handle kernel module dependencies for Elos</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_registry.html">Evaluation of the gitlab package registry, with regards to storing and using the elos subproject debian packages.</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Design Decisions - Enforce usage of _FORTIFY_SOURCE</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="adrs.html">Architecture Design Records</a><ul>
      <li>Previous: <a href="package_registry.html" title="previous chapter">Evaluation of the gitlab package registry, with regards to storing and using the elos subproject debian packages.</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, wolfgang.gehrhardt@emlix.com.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/generated/ADRs/usage_of_FORTIFY_SOURCE.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>